#!/bin/bash

# HashiCorp Vault PKI Certificate Issuance Demo
# Using demo-magic.sh for paced demonstrations

# Download demo-magic.sh if not present
if [ ! -f "demo-magic.sh" ]; then
    echo "Downloading demo-magic.sh..."
    curl -s https://raw.githubusercontent.com/paxtonhare/demo-magic/master/demo-magic.sh -o demo-magic.sh
    chmod +x demo-magic.sh
fi

# Source demo-magic
. ./demo-magic.sh

# Set demo speed
TYPE_SPEED=200
DEMO_PROMPT="${GREEN}โ ${CYAN}\W ${COLOR_RESET}"

# Vault configuration
export VAULT_ADDR="http://localhost:8200"
export VAULT_TOKEN="myroot"

# Clean up previous demo artifacts
rm -f *.crt *.csr *.key *.pem *.txt 2>/dev/null

# Reset PKI engines for clean demo
echo "๐งน Cleaning up from previous demo runs..."
vault secrets disable pki_int 2>/dev/null || true
vault secrets disable pki 2>/dev/null || true
vault secrets enable pki 2>/dev/null || true
vault secrets enable -path=pki_int pki 2>/dev/null || true
vault secrets tune -max-lease-ttl=87600h pki 2>/dev/null || true  
vault secrets tune -max-lease-ttl=43800h pki_int 2>/dev/null || true

clear

# Demo title
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ         HashiCorp Vault Enterprise PKI Certificate           โ"
echo "โ                    Issuance Demo                              โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo ""

echo -e "${YELLOW}This demo shows how to use HashiCorp Vault Enterprise for PKI certificate management${COLOR_RESET}"
echo ""
wait
clear

# Check Vault status
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                   Step 1: Verify Vault Status                 โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Let's start by checking our Vault Enterprise instance:"
echo ""
pe "vault status"
echo ""
echo "โ Vault Enterprise is running in development mode (auto-unsealed)"
wait
clear

# Show enabled secrets engines
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                Step 2: Review PKI Secrets Engines             โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Let's see what PKI secrets engines are already configured:"
echo ""
pe "vault secrets list"
echo ""
echo "๐ Notice we have two PKI engines enabled:"
echo "  โข pki/     - Root Certificate Authority (10-year max lease)"
echo "  โข pki_int/ - Intermediate Certificate Authority (5-year max lease)"
wait
clear

# Generate Root Certificate
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ               Step 3: Generate Root Certificate               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "First, let's generate a root certificate for our PKI:"
echo ""
pe "vault write -field=certificate pki/root/generate/internal common_name=\"Demo Root CA\" country=\"AU\" organization=\"HashiCorp Demo\" ttl=87600h > root-ca.crt"
echo ""
echo "โ Root certificate generated and saved to root-ca.crt"
pe "ls -la root-ca.crt"
wait
clear

# Configure PKI URLs
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                Step 4: Configure PKI URLs                     โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Configure URLs for certificate and CRL distribution:"
echo ""
pe "vault write pki/config/urls issuing_certificates=\"http://localhost:8200/v1/pki/ca\" crl_distribution_points=\"http://localhost:8200/v1/pki/crl\""
echo ""
echo "โ PKI URLs configured for certificate distribution"
wait
clear

# Create intermediate CA
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ            Step 5: Generate Intermediate Certificate          โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Now let's create an intermediate certificate authority:"
echo ""
echo "๐ง Generate intermediate CSR:"
pe "vault write -field=csr pki_int/intermediate/generate/internal common_name=\"Demo Intermediate CA\" country=\"AU\" organization=\"HashiCorp Demo\" > intermediate.csr"

echo ""
echo "๐ Sign intermediate CSR with root CA:"
pe "vault write -field=certificate pki/root/sign-intermediate csr=@intermediate.csr format=pem_bundle ttl=43800h > intermediate.crt"

echo ""
echo "๐ Set signed certificate on intermediate CA:"
pe "vault write pki_int/intermediate/set-signed certificate=@intermediate.crt"

echo ""
echo "โ Intermediate CA configured and ready for certificate issuance"
wait
clear

# Configure intermediate CA URLs
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ           Step 6: Configure Intermediate CA URLs              โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Configure URLs for the intermediate CA:"
echo ""
pe "vault write pki_int/config/urls issuing_certificates=\"http://localhost:8200/v1/pki_int/ca\" crl_distribution_points=\"http://localhost:8200/v1/pki_int/crl\""
echo ""
echo "โ Intermediate CA URLs configured"
wait
clear

# Create a role for certificate issuance
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                Step 7: Create Certificate Role                โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Create a role that defines what types of certificates can be issued:"
echo ""
pe "vault write pki_int/roles/web-server allowed_domains=\"example.com,demo.local\" allow_subdomains=true max_ttl=\"72h\" key_bits=2048 allow_any_name=false allow_localhost=true allow_ip_sans=true"
echo ""
echo "โ Certificate role 'web-server' created with domain restrictions"
wait
clear

# Issue a certificate
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ              Step 8: Issue a Server Certificate               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Now let's issue a certificate for a web server:"
echo ""
pe "vault write pki_int/issue/web-server common_name=\"web.example.com\" alt_names=\"api.example.com,www.example.com\" ip_sans=\"127.0.0.1,192.168.1.100\" ttl=\"24h\" format=pem_bundle"
echo ""
echo "๐ Certificate successfully issued!"
echo ""
echo "The response includes:"
echo "  โข ๐ certificate: The issued certificate"
echo "  โข ๐ private_key: The private key"
echo "  โข ๐ ca_chain: The certificate chain"
echo "  โข โฐ expiration: Unix timestamp of expiration"
wait
clear

# Issue certificate with metadata
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ            Step 8.5: Issue Certificate with Metadata          โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "HashiCorp Vault supports adding custom metadata to certificates:"
echo ""
echo "๐ท๏ธ  First, let's create metadata for our certificate:"
pe "echo '{\"department\": \"Engineering\", \"owner\": \"DevOps Team\", \"application\": \"Web Server\", \"environment\": \"Production\", \"cost_center\": \"CC-1001\"}' | base64 > cert_metadata.txt"
pe "cat cert_metadata.txt"

echo ""
echo "๐ Now issue a certificate with metadata:"
pe "vault write -field=serial_number pki_int/issue/web-server common_name=\"metadata.example.com\" ttl=\"24h\" cert_metadata=\$(cat cert_metadata.txt) > cert_serial.txt"
pe "cat cert_serial.txt"

echo ""
echo "โ Certificate with metadata issued successfully!"
wait
clear

# Save certificate components to files
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ           Step 9: Save Certificate Components                 โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Let's save the certificate components to separate files for easier use:"
echo ""
pe "vault write -field=certificate pki_int/issue/web-server common_name=\"app.example.com\" ttl=\"24h\" > app-cert.pem"

pe "vault write -field=private_key pki_int/issue/web-server common_name=\"api.example.com\" ttl=\"24h\" > api-key.pem"

pe "vault write -field=ca_chain pki_int/issue/web-server common_name=\"backend.example.com\" ttl=\"24h\" > ca-chain.pem"

echo ""
echo "โ Certificate files saved:"
pe "ls -la *.pem *.crt *.csr"
wait
clear

# Retrieve certificate metadata
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ             Step 10: Retrieve Certificate Metadata            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Let's retrieve and examine the certificate metadata we stored:"
echo ""
echo "๐ List all certificates with metadata:"
pe "vault list pki_int/cert-metadata/"
echo ""
echo "๐ Read metadata for our certificate:"
pe "vault read pki_int/cert-metadata/\$(cat cert_serial.txt)"
echo ""
echo "๐ฏ Decode the metadata to see the original JSON:"
pe "vault read -field=cert_metadata pki_int/cert-metadata/\$(cat cert_serial.txt) | base64 -d"
echo ""
echo "โ Certificate metadata successfully retrieved and decoded!"
wait
clear

# Verify certificate details
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ             Step 11: Verify Certificate Details               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Let's examine the certificate we just issued:"
echo ""
pe "openssl x509 -in app-cert.pem -text -noout | head -20"
echo ""
echo "๐ Key certificate details:"
echo "  โข Subject: Contains the common name we specified"
echo "  โข Issuer: Signed by our Intermediate CA"
echo "  โข Validity: 24-hour lifetime as requested"
echo "  โข Extensions: Subject Alternative Names, Key Usage, etc."
wait
clear

# Show certificate chain
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ              Step 12: Examine Certificate Chain               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Let's verify our certificate chain is properly constructed:"
echo ""
echo "๐ Certificate chain verification:"
pe "openssl verify -CAfile root-ca.crt -untrusted intermediate.crt app-cert.pem"
echo ""
echo "โ Certificate chain is valid and properly signed!"
wait
clear

# Revoke a certificate
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ              Step 13: Certificate Revocation                  โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "Demonstrate certificate revocation capabilities:"
echo ""
echo "๐ซ First, let's issue a certificate specifically for revocation:"
pe "vault write -field=serial_number pki_int/issue/web-server common_name=\"revoke-me.example.com\" ttl=\"1h\" > serial.txt"

echo ""
echo "๐ Certificate serial number:"
pe "cat serial.txt"

echo ""
echo "๐ซ Revoke the certificate:"
pe "vault write pki_int/revoke serial_number=\$(cat serial.txt)"

echo ""
echo "โ Certificate successfully revoked and added to CRL"
wait
clear

# Show CRL
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ           Step 14: Certificate Revocation List                โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo "View the Certificate Revocation List:"
echo ""
pe "curl -s \$VAULT_ADDR/v1/pki_int/crl/pem | openssl crl -inform PEM -text -noout"
echo ""
echo "๐ The CRL shows our revoked certificate serial number"
wait
clear

# Cleanup and summary
echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                         Demo Summary                          โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${COLOR_RESET}"
echo ""
echo "๐ ${GREEN}PKI Demo Completed Successfully!${COLOR_RESET}"
echo ""
echo "๐ What we accomplished:"
echo "  โ Configured Vault Enterprise PKI engines"
echo "  โ Generated root and intermediate Certificate Authorities"
echo "  โ Created certificate roles with domain restrictions"
echo "  โ Issued multiple server certificates with SANs and IP SANs"
echo "  โ Added custom metadata to certificates for tracking"
echo "  โ Retrieved and decoded certificate metadata"
echo "  โ Saved certificate components to files"
echo "  โ Verified certificate chain integrity"
echo "  โ Demonstrated certificate revocation"
echo ""
echo "๐ Generated files:"
pe "ls -la *.pem *.crt *.csr *.txt 2>/dev/null || echo 'No files generated in final demo run'"
echo ""
echo "๐ ${YELLOW}Next Steps:${COLOR_RESET}"
echo "  โข Use certificates in your applications"
echo "  โข Set up automatic certificate renewal"
echo "  โข Configure certificate templates for different use cases"
echo "  โข Integrate with CI/CD pipelines for automated certificate management"
echo ""
echo "${GREEN}Thank you for watching the HashiCorp Vault PKI Demo!${COLOR_RESET}"
echo ""